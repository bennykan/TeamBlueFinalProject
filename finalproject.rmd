---
title: "Property Value Prediction Using Clustering and Linear Regression - Automated Valuation Model (AVM)"
author: "Tyler Blakeley, Benjamin Kan, Mohammad Islam, Avijeet Singh"
date: "November 16 2018"
output:
  html_document:
    fig_height: 4.5
    fig_width: 7
    highlight: tango
    number_sections: yes
    theme: readable
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

# Business Understanding

We are the owners of a start-up company based in New York City who specializes in appraisal management and national real estate information, servicing major banks, lenders, mortgage insurers, credit unions, and independent mortgage brokers. Currently, most of the real estate transactions including mortgage loans and commercial property acquisitions rely on appraisers to estimate the property values. However, this could take at least days to complete, which the mortgage lenders and brokers think takes too long given the hyper competitive nature of the real estate industry. Moreover, the property valuation process is at times manual without comprehensive substantiation of how the appraisers come up with the values. Therefore, we reckon that the real estate appraisal industry is ripe for disruption. Our product is a property value prediction model which can be used by mortgage lenders and brokers to value the properties within minutes.  It is a national solution built using highly advanced machine learning algorithms, which can take into account extensive and diverse data sets, learn from the data in their environment, as well as incorporate new and different situations, as the market evolves.           

# Data Understanding

## Data Source and Collection

We sourced the NYC property sales data from Kaggle (https://www.kaggle.com/new-york-city/nyc-property-sales/home). This dataset contains the properties sold in NYC over a 12-month period from September 2016 to September 2017. The dataset contains 22 attributes including the precise property locations (Borough, Neighborhood, Block, Zip Code and Address), building class, property types (Residential or Commercial), property size and tax class. The dataset consists of about 84.5K of property sale transactions.

## Data Description

In the dataset, there are 22 variables. A detailed description of these variables can be found at https://www1.nyc.gov/assets/finance/downloads/pdf/07pdf/glossary_rsf071607.pdf

Variable Name                   | Description
--------------------------------|---------------------------------------------------------------------------
 #                              | ID of the property
BOROUGH                         | The name of the borough in which the property is located                    NEIGHBORHOOD                    | Neighborhood name in the course of valuing properties
BUILDING CLASS CATEGORY         | Building class descriptions
TAX CLASS                       | 1: Residential property up to three units; 2: All other property that is                                    | primarily residential (Co-ops and condos) 3: Property with equipment owned                                  | by a gas, telephone or electric company; 4: All other properties not                                        | included  
BLOCK                           | Sub-division of the borough on which the real properties are located
LOT                             | Subdivision of a block and represents the property unique location     
EASEMENT                        | A right which allows an entity to make limited use of another's real                                        | property
BUILDING CLASS AT PRESENT       | Building Code. Details can be found at
                                | https://www1.nyc.gov/assets/finance/jump/hlpbldgcode.html
ADDRESS                         | Street address of the property as listed on the Sales File. Coop sales                                      | include the apartment number
ZIP CODE                        | The property's postal code
RESIDENTIAL UNITS               | The number of residential units at the listed property
COMMERCIAL UNITS                | The number of commercial units at the listed property
LAND SQUARE FEET                | The land area of the property listed in square feet
GROSS SQUARE FEET               | The total area of all the floors of a building as measured from the exterior                                 | surfaces of the outside walls of the building
YEAR BUILT                      | Year the structure on the property was built
BUILDING CLASS AT TIME OF SALE  | The Building Classification is used to describe a propertyâ€™s constructive                                   | use. The first position of the Building Class is a letter that is used to                                   | describe a general class of properties
SALES PRICE                     | Price paid for the property
SALE DATE                       | Date of property sold

Note: $0 Sales Price: A $0 sale indicates that there was a transfer of ownership without a cash consideration. There can be a number of reasons for a $0 sale including transfers of ownership from parents to children. 

## Data Exploration

### Load Packages

```{r, message=FALSE,warning=FALSE}
#import packages;
library(dplyr)
library(reshape2)
library(ggplot2)
library(Hmisc)
library(corrplot)
library(mice)
library(VIM)
library(pROC)
library(caret)
library(corrgram)
library(GGally)
library(ggthemes) 
library(DMwR)
library(gridExtra)
library(rattle)
library(readxl)
library(cluster)
library(sqldf)
library(knitr)
```

### Load Datasets

Now that the packages are loaded, we can load in the dataset. Note that we converted the dataset file from the Excel to csv format.


```{r, message=FALSE,warning=FALSE}

data=read.csv(file.choose(), header = TRUE, na.strings = c("NA","","#NA"," -  "))
```

Now let us see how our dataset looks like:

```{r, message=FALSE,warning=FALSE}
str(data)
```

From the above we can see that 1st column has only the observation numbers and is not necessary for our data exploration so i will remove it for the time being and make a new dataset.

```{r, message=FALSE,warning=FALSE}
nyc_data<-as_data_frame(data[,-1])
```

Now we will introduce a new column which will only give me the BUILDING CLASS CATEGORY i.e "walkup aprartments","elevator apartments" etc. and not the numbers in front of them as they are not needed.
First i will remove the first three characters and check if it worked.

```{r, message=FALSE,warning=FALSE}
nyc_data$BUILDING.CLASS.CATEGORY<-substring(nyc_data$BUILDING.CLASS.CATEGORY,3)
head(nyc_data$BUILDING.CLASS.CATEGORY)
```

Instead of the numbers in the BOROUGH column we will put in the names:

```{r, message=FALSE,warning=FALSE}

nyc_data$BOROUGH <- ifelse(data$BOROUGH==1,'Manhattan',data$BOROUGH)
nyc_data$BOROUGH <- ifelse(data$BOROUGH==2,'Bronx',data$BOROUGH)
nyc_data$BOROUGH <- ifelse(data$BOROUGH==3,'Brooklyn',data$BOROUGH)
nyc_data$BOROUGH <- ifelse(data$BOROUGH==4,'Queens',data$BOROUGH)
nyc_data$BOROUGH <- ifelse(data$BOROUGH==5,'Staten Island',data$BOROUGH)
```

We will remove the column "EASE-MENT" as it has null value throughout:


#Check current variable type
```{r, message=FALSE,warning=FALSE}
str(data)

#Change the Borough to Categorical

data$BOROUGH <- as.factor(data$BOROUGH)

#Change ZIP.CODE to categorical

data$ZIP.CODE <- as.factor(data$ZIP.CODE)

#Change Sale.DATE to date 

data$SALE.DATE <- as.Date(data$SALE.DATE)

str(data)

```

```{r, message=FALSE,warning=FALSE}

summary(data)



#Remove sale price of 0 and NA's
data <- data[data$SALE.PRICE != 0,]
data <- data[!is.na(data$SALE.PRICE),]

#Remove any house built before 1776 america
#data <- data[data$YEAR.BUILT>=1776,]



#Remove outliers for sale.Price

# sp_plot = ggplot(data, aes(data$SALE.PRICE)) + geom_histogram(binwidth = 10000,colour="black",fill="white")+  scale_x_continuous("Sale.Price")+scale_y_continuous("Observations Count")+labs(title = "Histogram")
# sp_plot_2 = ggplot(data, aes(,data$SALE.PRICE)) + geom_boxplot(fill = "white")+  scale_y_continuous("Sale.Price")+scale_x_continuous("")+labs(title="Boxplot")
# sp_plot_2
# grid.arrange(sp_plot,sp_plot_2,nrow =1,top="SALE.PRICE DISTRIBUTION AND OUTLIERS" )



data_rm_outliers = data;

remove_outliers <- function(x,lbound) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = TRUE)
  H <- 1.5 * IQR(x, na.rm = TRUE)
  y=x
  y[x < (qnt[1] - H/lbound)] = -999999
  y[x > (qnt[2] + H)] = -999999
  y
  
}


data$SALE.PRICE <- remove_outliers(data_rm_outliers$SALE.PRICE,4)

data_out <- data[data$SALE.PRICE!=-999999,]





```





```{r, message=FALSE,warning=FALSE}

data_out$GROSS.SQUARE.FEET[data_out$GROSS.SQUARE.FEET == 0] <- NA

data_out$YEAR.BUILT[data_out$YEAR.BUILT <= 1776] <- NA

summary(data_out)


```


```{r, message=FALSE,warning=FALSE}
#Investigate Land square feet

table(data[data$LAND.SQUARE.FEET == 0,c('LAND.SQUARE.FEET','BUILDING.CLASS.CATEGORY')])




```


```{r, message=FALSE,warning=FALSE}

#Analyzed Missing values

aggr_plot = aggr(data_out, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(data_out), cex.axis=.7, gap=3, ylab=c("Histogram of missing data","Pattern"))


#remove easement columns all NA's and TOTAL.UNITS
data_out <- data_out[,!colnames(data_out) %in% c('EASE.MENT','X','TOTAL.UNITS')]

summary(data_out)

imputed_values <- function(x,borough) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = TRUE)
  H <- 1.5 * IQR(x, na.rm = TRUE)
  y=x
  y[x < (qnt[1] - H/lbound)] = -999999
  y[x > (qnt[2] + H)] = -999999
  y
  
}



borough_list <- c('Manhattan','Queens','Bronx','Brooklyn','Staten Island')

for (i in borough_list) {
Gross <- median(data_out$GROSS.SQUARE.FEET[data_out$BOROUGH==i & !is.na(data_out$GROSS.SQUARE.FEET)])
data_out$GROSS.SQUARE.FEET[data_out$BOROUGH==i & is.na(data_out$GROSS.SQUARE.FEET)] <- Gross

Land <- median(data_out$LAND.SQUARE.FEET[data_out$BOROUGH==i & !is.na(data_out$LAND.SQUARE.FEET)])
data_out$LAND.SQUARE.FEET[data_out$BOROUGH==i & is.na(data_out$LAND.SQUARE.FEET)] <- Land

Year_Built <- median(data_out$YEAR.BUILT[data_out$BOROUGH==i & !is.na(data_out$YEAR.BUILT)])
data_out$YEAR.BUILT[data_out$BOROUGH==i & is.na(data_out$YEAR.BUILT)] <- Year_Built
}
summary(data_out$GROSS.SQUARE.FEET)
summary(data_out$LAND.SQUARE.FEET)
summary(data_out$YEAR.BUILT)

summary(data_out)

#Apply KNN
 
 # knn_input=as.data.frame(data_out[, !names(data_out) %in% c("SALE.PRICE")])
 # #Confrim structure has not changed except for lost of target variable
 # str(knn_input)
# 
# #Allow for reproducable results
# set.seed(847593)
# 
# #Run KNN imputation, use built in scacle = T to rescale all data.  
# knnOutput = knnImputation(knn_input, k=7,scale=T)
# 
# #Check if all missing values have been imputeted
# summary(knnOutput)
# 



```